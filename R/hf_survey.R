
#' Accumulated travel time
#'
#' Survey entire landscape to calculate accumulated cost of travel from one or
#' more start points.
#'
#' @param x a cost `terrain` generated by `hf_terrain()`.
#' @param from an `sf` specifying start locations, must be POINT or MULTIPOINT.
#'
#' @return a `SpatRaster` with accumulated travel costs from each start point.
#' @export
#'
#' @examples
#' library(sf)
#' library(terra)
#'
#' fn <- system.file("extdata/red_butte_dem.tif", package = "hiker")
#' red_butte_dem <- rast(fn)
#'
#' from <- st_sf(geometry = st_sfc(st_point(c(432000, 4514000)),
#'                                 st_point(c(434000, 4518000)),
#'                                 crs = 26912))
#'
#' terrain <- hf_terrain(red_butte_dem)
#'
#' cost_surface <- hf_survey(terrain, from)
#'
#' plot(cost_surface)
#' plot(st_geometry(from), pch = 19, col = "red2", add = TRUE)
#'
hf_survey <- function(x, from) {

  stop_if_not_terrain(x)

  stop_if_not_sf(from)
  stop_if_not_point(from)

  stop_if_not_crs_equal(x$epsg, from)

  from_xy <- sf::st_coordinates(from)[, 1:2, drop = FALSE]

  rr <- terra::rast(nrow   = x$nrow,
                    ncol   = x$ncol,
                    extent = terra::ext(x$bb8),
                    crs    = x$epsg)

  from_cells <- terra::cellFromXY(rr, from_xy)
  to_cells <- 1:terra::ncell(rr)

  graph <- igraph::graph_from_adjacency_matrix(x$conductance,
                                               mode = "directed",
                                               weighted = TRUE)

  # invert conductance to get travel cost
  igraph::E(graph)$weight <- (1/igraph::E(graph)$weight)

  # this cost matrix has a row for each start point
  # to get the cost surface from all of them, we take the minimum from each start
  # a faster strategy than looping through each pixel might be to fold each start
  # into a SpatRaster and let terra do it in C++ all at once
  cost <- igraph::distances(graph, from_cells, to_cells, mode = "out")

  cost <- apply(t(cost), 1, min)

  rr[to_cells] <- c(t(cost))

  return(rr)

}
